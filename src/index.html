<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>无人机实时监控系统</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=c2c5ca77bbbc732a1144127e4ae9994b&plugin=AMap.ToolBar,AMap.Scale"></script>
  <script src="mqtt.min.js"></script>
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            dark: '#1D2129',
            'dark-2': '#4E5969',
            'light-1': '#F2F3F5',
            'light-2': '#E5E6EB'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      .data-update {
        animation: fadeIn 0.5s ease-in-out;
      }
      .slide-down {
        animation: slideDown 0.3s ease-out forwards;
      }
      .slide-up {
        animation: slideUp 0.3s ease-in forwards;
      }
    }
  </style>
  
  <style>
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { background-color: rgba(22, 93, 255, 0.1); }
      to { background-color: transparent; }
    }
    
    @keyframes slideDown {
      from { max-height: 0; opacity: 0; overflow: hidden; }
      to { max-height: 500px; opacity: 1; }
    }
    
    @keyframes slideUp {
      from { max-height: 500px; opacity: 1; }
      to { max-height: 0; opacity: 0; overflow: hidden; }
    }

    /* MQTT相关样式 */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-red { background-color: #ef4444; }
    .status-green { background-color: #10b981; }
    .status-yellow { background-color: #f59e0b; }
    
    .mqtt-connection { display: flex; align-items: center; font-size: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
    .mqtt-info { display: flex; align-items: center; }
    
    .mqtt-broker {
      font-size: 0.75rem;
      color: #6b7280;
      margin-left: 8px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mqtt-controls button {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }
    
    .connect-btn { background-color: #3b82f6; color: white; }
    .connect-btn:hover { background-color: #2563eb; }
    .disconnect-btn { background-color: #ef4444; color: white; margin-left: 8px; }
    .disconnect-btn:hover { background-color: #dc2626; }
    
    .mqtt-settings { margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0; }
    .mqtt-setting-item { margin-bottom: 6px; }
    .mqtt-setting-item label { display: inline-block; width: 70px; font-size: 0.8rem; }
    .mqtt-setting-item input {
      width: calc(100% - 75px);
      padding: 4px;
      border-radius: 3px;
      border: 1px solid #e2e8f0;
      font-size: 0.8rem;
    }
    
    .message-area { margin-top: 10px; }
    .receive-area {
      margin-top: 5px;
      padding: 8px;
      background-color: #f8fafc;
      border-radius: 4px;
      font-size: 0.75rem;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
    }
    
    .send-area {
      margin-top: 5px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .send-area textarea {
      width: 100%;
      padding: 4px;
      border-radius: 3px;
      border: 1px solid #e2e8f0;
      font-size: 0.8rem;
      min-height: 60px;
      resize: vertical;
    }
    
    .send-area button {
      align-self: flex-end;
      padding: 4px 10px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    
    .send-area button:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }

    /* 无人机信息样式 */
    .drone-info-container {
      font-size: 0.85rem;
    }
    .drone-info-container .text-sm {
      font-size: 0.75rem;
    }
    .drone-info-container .data-item {
      padding: 1px 2px;
      margin-bottom: 2px;
    }
    .drone-info-container h2 {
      font-size: 0.95rem;
      margin-bottom: 3px;
    }

    /* 高德地图信息窗口样式调整 */
    .amap-info-contentContainer {
      width: auto !important;
      max-width: 180px !important;
      padding: 4px !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important;
    }
    .amap-info-contentContainer p {
      margin: 2px 0 !important;
      font-size: 11px !important;
      line-height: 1.2 !important;
    }
    .amap-info-contentContainer strong {
      font-size: 11px !important;
    }
    
    /* 增强信息窗口偏移样式 */
    .amap-info-window {
      transform: translateY(-40px) !important;
      bottom: 0 !important;
      margin-bottom: 0 !important;
    }
    
    .amap-info-contentContainer {
      margin-bottom: 0 !important;
    }
    
    .amap-info-sharp {
      bottom: -10px !important;
      transform: translateX(-50%) !important;
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
      .mqtt-connection {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .mqtt-controls {
        margin-top: 0.5rem;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .map-container {
        height: 40vh !important;
      }
    }
  </style>
</head>
<body class="font-inter bg-light-1 text-dark min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-md z-10">
    <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
      <div class="flex items-center space-x-3">
        <i class="fa fa-plane text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-primary">无人机实时监控系统</h1>
      </div>
      
      <div class="flex flex-wrap items-center space-x-4 mt-2 sm:mt-0">
        <div class="hidden md:flex items-center space-x-1 text-dark-2">
          <i class="fa fa-refresh"></i>
          <span id="update-time">最后更新：加载中...</span>
        </div>
        
        <!-- 数据导出按钮 -->
        <button id="export-data" class="bg-primary text-white px-3 py-1 rounded text-sm flex items-center hover:bg-primary/90 transition-colors">
          <i class="fa fa-download mr-1"></i>导出数据
        </button>
        
        <!-- MQTT连接状态区域 -->
        <div class="mqtt-connection">
          <div class="mqtt-info">
            <span id="mqtt-indicator" class="status-indicator status-red"></span>
            <span id="mqtt-status">MQTT未连接</span>
            <span class="mqtt-broker">
              服务器: <span id="current-broker">未设置</span>
            </span>
          </div>
          <div class="mqtt-controls">
            <button id="mqtt-connect" class="connect-btn">
              <i class="fa fa-plug mr-1"></i>连接
            </button>
            <button id="mqtt-disconnect" class="disconnect-btn" disabled>
              <i class="fa fa-unplug mr-1"></i>断开
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow flex flex-col md:flex-row main-content">
    <!-- 左侧信息面板 -->
    <div class="w-full md:w-1/4 bg-white p-4 md:p-6 overflow-y-auto transition-all duration-300">
      <!-- 无人机信息部分 -->
      <div class="mb-6 drone-info-container">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-info-circle text-primary mr-2"></i>无人机信息
        </h2>
        <div class="space-y-3 card-shadow rounded-lg p-4">
          <!-- 无人机信息项 -->
          <div class="data-item p-2 rounded hover:bg-light-1 transition-colors">
            <div class="text-sm text-dark-2">无人机编号</div>
            <div id="uas-id" class="font-medium">--</div>
          </div>
          <div class="data-item p-2 rounded hover:bg-light-1 transition-colors">
            <div class="text-sm text-dark-2">时间戳</div>
            <div id="timestamp" class="font-medium">--</div>
          </div>
          <div class="data-item p-2 rounded hover:bg-light-1 transition-colors">
            <div class="text-sm text-dark-2">信号类型</div>
            <div id="sig" class="font-medium">--</div>
          </div>
          <div class="data-item p-2 rounded hover:bg-light-1 transition-colors">
            <div class="text-sm text-dark-2">定位类型</div>
            <div id="fix" class="font-medium">--</div>
          </div>
          <div class="data-item p-2 rounded hover:bg-light-1 transition-colors">
            <div class="text-sm text-dark-2">经纬度</div>
            <div id="latlon" class="font-medium">--</div>
          </div>
        </div>
      </div>
      
      <!-- 状态信息部分 -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-signal text-primary mr-2"></i>状态信息
        </h2>
        <div class="card-shadow rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-dark-2">定位质量</span>
            <span id="signal-status" class="px-2 py-1 rounded text-xs bg-success text-white">无效</span>
          </div>
          <div class="w-full bg-light-2 rounded-full h-2.5 mb-4">
            <div id="signal-bar" class="bg-success h-2.5 rounded-full transition-all duration-500" style="width: 90%"></div>
          </div>
          
          <div class="flex items-center justify-between mb-3">
            <span class="text-dark-2">定位状态</span>
            <span id="fix-status" class="px-2 py-1 rounded text-xs bg-success text-white">已定位</span>
          </div>
          
          <div class="flex items-center justify-between">
            <span class="text-dark-2">设备状态</span>
            <span id="device-status" class="px-2 py-1 rounded text-xs bg-success text-white">正常</span>
          </div>
        </div>
      </div>
      
      <!-- 数据记录统计 -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-database text-primary mr-2"></i>数据记录
        </h2>
        <div class="card-shadow rounded-lg p-4">
          <div class="flex justify-between items-center">
            <span class="text-dark-2">已记录数据条数:</span>
            <span id="record-count" class="font-medium">0</span>
          </div>
          <div class="mt-3">
            <button id="clear-data" class="text-sm text-danger hover:underline transition-colors">
              <i class="fa fa-trash mr-1"></i>清空记录
            </button>
          </div>
        </div>
      </div>
      
      <!-- MQTT设置部分 -->
      <div>
        <h2 class="text-lg font-semibold mb-4 flex items-center cursor-pointer" id="mqtt-settings-toggle">
          <i class="fa fa-cogs text-primary mr-2"></i>服务器设置
          <i class="fa fa-chevron-down ml-auto text-xs transition-transform duration-300"></i>
        </h2>
        <div class="card-shadow rounded-lg p-4 overflow-hidden" id="mqtt-settings-content" style="max-height:0; opacity:0; overflow:hidden;">
          <div class="mqtt-settings">
            <div class="mqtt-setting-item">
              <label for="mqtt-host">服务器:</label>
              <input type="text" id="mqtt-host" value="42.236.69.54" placeholder="MQTT服务器地址">
            </div>
            <div class="mqtt-setting-item">
              <label for="mqtt-port">端口:</label>
              <input type="number" id="mqtt-port" value="8083" placeholder="MQTT端口">
            </div>
            <div class="mqtt-setting-item">
              <label for="mqtt-device-id">设备ID:</label>
              <input type="text" id="mqtt-device-id" value="862057079423353" placeholder="设备ID（可选）">
            </div>
          </div>
          
          <!-- 消息接收区域 -->
          <div class="message-area">
            <h4 class="text-sm font-medium">接收消息 (主题: terminal/l20/+/getInfo):</h4>
            <div id="receiveData" class="receive-area"></div>
          </div>
		  
		  <!-- 消息发送区域 -->
          <div class="message-area">
            <h4 class="text-sm font-medium">发送消息 (主题: terminal/l20/${deviceId}/setInfo):</h4>
            <div class="send-area">
              <textarea id="sendMessage" placeholder="输入要发送的消息（JSON格式）"></textarea>
              <button id="sendButton" disabled>发送</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 右侧地图区域 -->
    <div class="w-full md:w-3/4 h-[60vh] md:h-[calc(100vh-64px)] relative map-container">
      <div id="map-container" class="w-full h-full"></div>
      <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-lg card-shadow">
        <div class="flex items-center">
          <div class="w-3 h-3 bg-primary rounded-full pulse-animation mr-2"></div>
          <span class="text-sm font-medium">无人机实时位置</span>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white py-3 text-center text-dark-2 text-sm">
    <p>© 2023 无人机监控系统 | 数据更新间隔: 实时</p>
  </footer>

  <script>
    // 模块化组织代码
    document.addEventListener('DOMContentLoaded', function() {
      // 新增：实现WGS84转GCJ02坐标转换函数（替代coordtransform.js）
      const CoordTransform = {
        PI: 3.141592653589793,
        a: 6378245.0,
        ee: 0.00669342162296594323,
        
        // WGS84转GCJ02（火星坐标系）
        wgs84togcj02: function(lng, lat) {
          if (this.outOfChina(lng, lat)) {
            return [lng, lat];
          }
          let dlat = this.transformLat(lng - 105.0, lat - 35.0);
          let dlng = this.transformLng(lng - 105.0, lat - 35.0);
          const radlat = lat / 180.0 * this.PI;
          let magic = Math.sin(radlat);
          magic = 1 - this.ee * magic * magic;
          const sqrtmagic = Math.sqrt(magic);
          dlat = (dlat * 180.0) / ((this.a * (1 - this.ee)) / (magic * sqrtmagic) * this.PI);
          dlng = (dlng * 180.0) / (this.a / sqrtmagic * Math.cos(radlat) * this.PI);
          const mglat = lat + dlat;
          const mglng = lng + dlng;
          return [mglng, mglat];
        },
        
        transformLat: function(x, y) {
          let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
          ret += (20.0 * Math.sin(6.0 * x * this.PI) + 20.0 * Math.sin(2.0 * x * this.PI)) * 2.0 / 3.0;
          ret += (20.0 * Math.sin(y * this.PI) + 40.0 * Math.sin(y / 3.0 * this.PI)) * 2.0 / 3.0;
          ret += (160.0 * Math.sin(y / 12.0 * this.PI) + 320 * Math.sin(y * this.PI / 30.0)) * 2.0 / 3.0;
          return ret;
        },
        
        transformLng: function(x, y) {
          let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
          ret += (20.0 * Math.sin(6.0 * x * this.PI) + 20.0 * Math.sin(2.0 * x * this.PI)) * 2.0 / 3.0;
          ret += (20.0 * Math.sin(x * this.PI) + 40.0 * Math.sin(x / 3.0 * this.PI)) * 2.0 / 3.0;
          ret += (150.0 * Math.sin(x / 12.0 * this.PI) + 300.0 * Math.sin(x / 30.0 * this.PI)) * 2.0 / 3.0;
          return ret;
        },
        
        outOfChina: function(lng, lat) {
          if (lng < 72.004 || lng > 137.8347) {
            return true;
          }
          if (lat < 0.8293 || lat > 55.8271) {
            return true;
          }
          return false;
        }
      };

      // DOM元素获取与缓存
      const DOM = {
        // 数据导出和统计元素
        exportDataBtn: document.getElementById('export-data'),
        clearDataBtn: document.getElementById('clear-data'),
        recordCountEl: document.getElementById('record-count'),
        
        // MQTT相关
        mqttConnectBtn: document.getElementById('mqtt-connect'),
        mqttDisconnectBtn: document.getElementById('mqtt-disconnect'),
        mqttIndicator: document.getElementById('mqtt-indicator'),
        mqttStatus: document.getElementById('mqtt-status'),
        currentBrokerEl: document.getElementById('current-broker'),
        receiveArea: document.getElementById('receiveData'),
        mqttSettingsToggle: document.getElementById('mqtt-settings-toggle'),
        mqttSettingsContent: document.getElementById('mqtt-settings-content'),
        sendMessageInput: document.getElementById('sendMessage'),
        sendButton: document.getElementById('sendButton'),
        
        // MQTT设置输入框
        mqttHostInput: document.getElementById('mqtt-host'),
        mqttPortInput: document.getElementById('mqtt-port'),
        mqttDeviceIdInput: document.getElementById('mqtt-device-id'),
        
        // 数据显示元素
        updateTime: document.getElementById('update-time'),
        uasId: document.getElementById('uas-id'),
        timestamp: document.getElementById('timestamp'),
        sig: document.getElementById('sig'),
        fix: document.getElementById('fix'),
        latlon: document.getElementById('latlon'),
        signalStatus: document.getElementById('signal-status'),
        signalBar: document.getElementById('signal-bar'),
        fixStatus: document.getElementById('fix-status'),
        deviceStatus: document.getElementById('device-status')
      };

      // 应用状态管理
      const appState = {
        mqtt: { 
          client: null, 
          brokerUrl: '', 
          subscribeTopic: 'terminal/l20/+/getInfo',
          publishTopic: '',
          connected: false 
        },
        drones: {}, // 存储所有无人机数据，键为无人机ID
        selectedDroneId: null, // 当前选中的无人机ID
        historicalData: [], // 存储历史数据，仅包含选中的无人机
        map: null,
        infoWindow: null,
        droneMarkers: {}, // 存储所有无人机的标记
        trackPoints: {},     // 存储所有无人机的轨迹点
        trackPolylines: {}   // 存储所有无人机的轨迹线
      };

      // 工具函数
      const Utils = {
        // 格式化时间
        formatTime(timestamp) {
          const date = new Date(parseInt(timestamp || Date.now()));
          return date.toLocaleString('zh-CN', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
        },
        
        // 显示通知消息
        showMessage(message, isError = false) {
          const messageEl = document.createElement('div');
          messageEl.className = `text-sm mb-1 ${isError ? 'text-danger' : 'text-dark-2'}`;
          messageEl.textContent = `[${this.formatTime()}] ${message}`;
          
          DOM.receiveArea.prepend(messageEl);
          
          // 限制消息数量
          if (DOM.receiveArea.children.length > 100) {
            DOM.receiveArea.removeChild(DOM.receiveArea.lastChild);
          }
        },
        
        // 导出数据为txt
		 exportToTXT(data, filename) {
			if (!data || data.length === 0) {
			  this.showMessage('没有可导出的数据', true);
			  return;
			}
		 // 构建TXT内容，使用更易读的格式
			let txtContent = '无人机监控数据记录\n';
			txtContent += '========================================\n';
			txtContent += `导出时间: ${this.formatTime()}\n`;
			txtContent += `记录总数: ${data.length} 条\n`;
			txtContent += '========================================\n\n';
			
			// 添加表头说明
			txtContent += '时间\t\t无人机ID\t高度(m)\t速度(m/s)\t经度\t纬度\n';
			txtContent += '------------------------------------------------------------------------\n';
			
			// 添加每条记录
			data.forEach(row => {
			  txtContent += `${row.timestamp}\t${row.uasId}\t${row.height}\t${row.speed}\t${row.lon}\t${row.lat}\n`;
			});
			
			// 创建TXT文件并下载
			const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.setAttribute('href', url);
			link.setAttribute('download', filename || 'drone_data.txt'); // 文件名改为txt后缀
			link.style.visibility = 'hidden';
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
			
			this.showMessage('数据导出为TXT成功');
        },
        
        // 信号类型转换
        getSignalType(sig) {
          const signalTypes = {0: '正常', 1: '弱', 2: '丢失'};
          return signalTypes[sig] || `未知(${sig})`;
        },
        
        // 定位类型转换
        getFixType(fix) {
          const fixTypes = {0: '未定位', 1: '2D定位', 2: '3D定位', 3: '北斗定位'};
          return fixTypes[fix] || `未知(${fix})`;
        }
      };

      // 地图服务
      const MapService = {
        // 初始化地图
        initMap() {
          // 创建地图实例
          appState.map = new AMap.Map('map-container', {
            zoom: 6,
            center: [114.3, 36.1], // 默认坐标
            resizeEnable: true
          });
          
          // 添加比例尺和工具栏
          appState.map.addControl(new AMap.Scale());
          appState.map.addControl(new AMap.ToolBar());
          
          // 创建信息窗口，并设置关闭事件监听
          appState.infoWindow = new AMap.InfoWindow({
            offset: new AMap.Pixel(0, -30)
          });
          
          // 监听信息窗口关闭事件 - 核心修改点
          appState.infoWindow.on('close', () => {
            if (appState.selectedDroneId) {
              Utils.showMessage(`信息窗口已关闭，停止记录无人机 ${appState.selectedDroneId} 数据`);
              appState.selectedDroneId = null; // 取消选中状态
            }
          });
          
          // 尝试获取用户位置并居中
          this.getUserLocation();
        },
        
        // 获取用户位置并居中地图
        getUserLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { longitude, latitude } = position.coords;
                // 转换为高德坐标
                const [gcjLng, gcjLat] = CoordTransform.wgs84togcj02(longitude, latitude);
                appState.map.setCenter([gcjLng, gcjLat]);
                appState.map.setZoom(12);
                Utils.showMessage('已获取您的位置并居中地图');
              },
              (error) => {
                Utils.showMessage(`获取位置失败: ${error.message}`, true);
              }
            );
          } else {
            Utils.showMessage('您的浏览器不支持地理定位', true);
          }
        },
        
        // 更新无人机标记 - 恢复quadx.png图标
// 修改MapService.updateDroneMarker方法中创建标记的部分
updateDroneMarker(droneData) {
  const { uasId, lon, lat, height, speed, timestamp, sig, fix, direction } = droneData;
  
  // 坐标转换
  const [gcjLon, gcjLat] = CoordTransform.wgs84togcj02(lon, lat);
  
  // 保存无人机数据
  appState.drones[uasId] = { ...droneData, gcjLon, gcjLat };
  
  // 如果是选中的无人机，更新信息面板
  if (uasId === appState.selectedDroneId) {
    this.updateInfoPanel(droneData);
  }
  
  // 创建包含图标和编号的自定义内容
  const markerContent = `
 <div style="position: relative;">
    <img src="quadx.png" style="width: 30px; height: 30px; transform: translateY(5px);" />
    <div style="position: absolute; top: 30px; right: -7px; color: #ef5d44; 
                border-radius: 50%; width: 16px; height: 16px; display: flex; 
                align-items: center; justify-content: center; font-size: 10px; font-weight: bold;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
      ${uasId.slice(-4)}
    </div>
  </div>
  `;
  
  // 创建或更新无人机标记
  if (!appState.droneMarkers[uasId]) {
    // 创建新标记
    const marker = new AMap.Marker({
      position: [gcjLon, gcjLat],
      content: markerContent, // 使用自定义内容
      anchor: 'center',
      //rotation: direction ? direction / 100 : 0,
      zIndex: 10
    });
    
    appState.droneMarkers[uasId] = marker;
    appState.map.add(marker);
    
    // 绑定点击事件
    marker.on('click', () => {
      this.selectDrone(uasId);
    });
  } else {
    // 更新现有标记位置、旋转角度和内容
    appState.droneMarkers[uasId].setPosition([gcjLon, gcjLat]);
    //appState.droneMarkers[uasId].setRotation(direction ? direction / 100 : 0);
    appState.droneMarkers[uasId].setContent(markerContent); // 更新内容以确保编号正确
	appState.droneMarkers[uasId].setAnchor('center'); // 确保现有标记也更新锚点
  }
  
  // 更新轨迹
  this.updateDroneTrack(uasId, gcjLon, gcjLat, timestamp);
},
        
        // 更新无人机轨迹
        updateDroneTrack(uasId, lon, lat, timestamp) {
          // 初始化轨迹数据
          if (!appState.trackPoints[uasId]) {
            appState.trackPoints[uasId] = [];
          }
          
          // 添加新轨迹点
          appState.trackPoints[uasId].push([lon, lat, timestamp]);
          
          // 限制轨迹点数量
          const MAX_POINTS = 1000;
          if (appState.trackPoints[uasId].length > MAX_POINTS) {
            appState.trackPoints[uasId].shift();
          }
          
          // 创建或更新轨迹线
          if (!appState.trackPolylines[uasId]) {
            // 创建新轨迹线
            const polyline = new AMap.Polyline({
              path: appState.trackPoints[uasId].map(p => [p[0], p[1]]),
              strokeColor: '#31e818', // 灰色（可根据需求调整深浅，如#666666/#cccccc）
              strokeWeight: 2,
			  strokeStyle: 'dashed', // 线条样式：虚线
              zIndex: 5
            });
            
            appState.trackPolylines[uasId] = polyline;
            appState.map.add(polyline);
          } else {
            // 更新现有轨迹线
            appState.trackPolylines[uasId].setPath(
              appState.trackPoints[uasId].map(p => [p[0], p[1]])
            );
          }
        },
        
        // 选中无人机并显示信息窗口
        selectDrone(uasId) {
          const drone = appState.drones[uasId];
          if (!drone) return;
          
          appState.selectedDroneId = uasId;
          
          // 更新信息面板
          this.updateInfoPanel(drone);
          
          // 移动地图到无人机位置
          appState.map.setCenter([drone.gcjLon, drone.gcjLat]);
          
          // 显示信息窗口
          const content = `
            <div class="drone-info-container">
              <h3>无人机 ${uasId}</h3>
              <p><strong>时间:</strong> ${Utils.formatTime(drone.timestamp)}</p>
              <p><strong>经纬度:</strong> ${drone.lat.toFixed(6)}, ${drone.lon.toFixed(6)}</p>
              <p><strong>高度:</strong> ${drone.height ? drone.height.toFixed(1) + ' m' : '--'}</p>
              <p><strong>速度:</strong> ${drone.speed ? drone.speed.toFixed(1) + ' m/s' : '--'}</p>
              <p><strong>信号:</strong> ${Utils.getSignalType(drone.sig)}</p>
              <p><strong>定位:</strong> ${Utils.getFixType(drone.fix)}</p>
            </div>
          `;
          
          appState.infoWindow.setContent(content);
          appState.infoWindow.open(appState.map, [drone.gcjLon, drone.gcjLat]);
          
          Utils.showMessage(`已选中无人机 ${uasId}，开始记录数据`);
        },
        
        // 更新信息面板
        updateInfoPanel(droneData) {
          const { uasId, timestamp, sig, fix, lon, lat, height, speed } = droneData;
          
          // 更新显示数据
          DOM.uasId.textContent = uasId;
          DOM.timestamp.textContent = Utils.formatTime(timestamp);
          DOM.sig.textContent = Utils.getSignalType(sig);
          DOM.fix.textContent = Utils.getFixType(fix);
          DOM.latlon.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          DOM.updateTime.textContent = `最后更新：${Utils.formatTime()}`;
          
          // 更新状态指示器
          let signalQuality = 0;
          let signalText = '弱';
          let signalColor = 'bg-danger';
          
          switch(sig) {
            case 0: // 正常
              signalQuality = 90;
              signalText = '良好';
              signalColor = 'bg-success';
              break;
            case 1: // 弱
              signalQuality = 50;
              signalText = '较弱';
              signalColor = 'bg-warning';
              break;
            case 2: // 丢失
              signalQuality = 10;
              signalText = '丢失';
              signalColor = 'bg-danger';
              break;
            default:
              signalQuality = 30;
              signalText = '未知';
              signalColor = 'bg-dark-2';
          }
          
          DOM.signalBar.style.width = `${signalQuality}%`;
          DOM.signalBar.className = `h-2.5 rounded-full transition-all duration-500 ${signalColor}`;
          DOM.signalStatus.textContent = signalText;
          DOM.signalStatus.className = `px-2 py-1 rounded text-xs ${signalColor} text-white`;
          
          // 更新定位状态
          let fixText, fixColor;
          switch(fix) {
            case 0: // 未定位
              fixText = '未定位';
              fixColor = 'bg-danger';
              break;
            case 1: // 2D定位
              fixText = '2D定位';
              fixColor = 'bg-warning';
              break;
            case 2: // 3D定位
            case 3: // 北斗定位
              fixText = fix === 2 ? '3D定位' : '北斗定位';
              fixColor = 'bg-success';
              break;
            default:
              fixText = '未知';
              fixColor = 'bg-dark-2';
          }
          
          DOM.fixStatus.textContent = fixText;
          DOM.fixStatus.className = `px-2 py-1 rounded text-xs ${fixColor} text-white`;
          
          // 更新设备状态
          const isDeviceNormal = sig !== 2 && fix !== 0;
          DOM.deviceStatus.className = `px-2 py-1 rounded text-xs ${isDeviceNormal ? 'bg-success' : 'bg-danger'} text-white`;
          DOM.deviceStatus.textContent = isDeviceNormal ? '正常' : '异常';
          
          // 闪烁效果表示数据更新
          [DOM.uasId, DOM.timestamp, DOM.sig, DOM.fix, DOM.latlon].forEach(el => {
            el.classList.add('data-update');
            setTimeout(() => el.classList.remove('data-update'), 500);
          });
          
          // 记录数据（仅当信息窗口打开时）
          DataManager.saveDataToHistory(timestamp, uasId, height, speed, lon, lat);
        }
      };

      // 数据管理
      const DataManager = {
        // 保存数据到历史记录
        saveDataToHistory(timestamp, uasId, height, speed, lon, lat) {
          // 核心修改点：只有选中了无人机且信息窗口打开时才记录数据
          if (!appState.selectedDroneId || !appState.infoWindow.getIsOpen()) return;
          
          const record = {
            timestamp: Utils.formatTime(timestamp),
            uasId: uasId || '未知',
            height: height !== undefined ? height.toFixed(1) : '--',
            speed: speed !== undefined ? speed.toFixed(1) : '--',
            lon: lon.toFixed(6),
            lat: lat.toFixed(6)
          };
          
          appState.historicalData.push(record);
          
          // 更新记录计数显示
          DOM.recordCountEl.textContent = appState.historicalData.length;
          
          // 限制最大记录数，防止内存占用过大
          const MAX_RECORDS = 10000;
          if (appState.historicalData.length > MAX_RECORDS) {
            appState.historicalData.shift(); // 移除最早的记录
          }
          
          Utils.showMessage(`已记录无人机 ${uasId} 数据 (共 ${appState.historicalData.length} 条)`);
        },
        
        // 清空历史数据
        clearHistoricalData() {
          if (confirm('确定要清空所有记录的数据吗？此操作不可恢复。')) {
            appState.historicalData = [];
            DOM.recordCountEl.textContent = '0';
            Utils.showMessage('已清空所有记录数据');
          }
        },
        
        // 导出历史数据
  // 导出历史数据（调用TXT导出方法）
		  exportHistoricalData() {
			Utils.exportToTXT(appState.historicalData, `drone_data_${new Date().getTime()}.txt`);
		  }
      };

      // MQTT服务
      const MqttService = {
        // 连接MQTT服务器
        connect() {
          const host = DOM.mqttHostInput.value.trim();
          const port = DOM.mqttPortInput.value.trim();
          const deviceId = DOM.mqttDeviceIdInput.value.trim();
          
          if (!host || !port) {
            Utils.showMessage('请填写MQTT服务器地址和端口', true);
            return;
          }
          
          // 构建连接URL
          appState.mqtt.brokerUrl = `ws://${host}:${port}/mqtt`;
          appState.mqtt.publishTopic = deviceId ? `terminal/l20/${deviceId}/setInfo` : '';
          
          // 更新UI
          DOM.currentBrokerEl.textContent = `${host}:${port}`;
          DOM.mqttConnectBtn.disabled = true;
          DOM.mqttConnectBtn.textContent = '连接中...';
          Utils.showMessage(`正在连接到 ${appState.mqtt.brokerUrl}`);
          
          // 创建MQTT客户端
          appState.mqtt.client = mqtt.connect(appState.mqtt.brokerUrl, {
            clientId: `drone-monitor-${Math.random().toString(16).substr(2, 8)}`,
            clean: true,
            connectTimeout: 4000,
            reconnectPeriod: 1000
          });
          
          // 连接成功回调
          appState.mqtt.client.on('connect', () => {
            appState.mqtt.connected = true;
            DOM.mqttIndicator.className = 'status-indicator status-green';
            DOM.mqttStatus.textContent = 'MQTT已连接';
            DOM.mqttConnectBtn.disabled = true;
            DOM.mqttDisconnectBtn.disabled = false;
            DOM.mqttConnectBtn.textContent = '连接';
            DOM.sendButton.disabled = !appState.mqtt.publishTopic;
            
            Utils.showMessage('MQTT连接成功');
            
            // 订阅主题
            appState.mqtt.client.subscribe(appState.mqtt.subscribeTopic, (err) => {
              if (!err) {
                Utils.showMessage(`已订阅主题: ${appState.mqtt.subscribeTopic}`);
              } else {
                Utils.showMessage(`订阅主题失败: ${err.message}`, true);
              }
            });
          });
          
          // 接收消息回调
          appState.mqtt.client.on('message', (topic, message) => {
            try {
              const data = JSON.parse(message.toString());
              Utils.showMessage(`收到消息: ${topic} -> ${JSON.stringify(data)}`);
              
              // 处理无人机数据 - 兼容两种数据格式
              const droneData = data.data || data;
              if (topic.includes('getInfo') && (droneData.uasId || droneData.uas_id)) {
                // 统一数据格式
                const normalizedData = {
                  uasId: droneData.uasId || droneData.uas_id,
                  lon: droneData.lon || droneData.longitude,
                  lat: droneData.lat || droneData.latitude,
                  height: droneData.height || droneData.altitude,
                  speed: droneData.speed,
                  timestamp: droneData.timestamp || Date.now(),
                  sig: droneData.sig,
                  fix: droneData.fix,
                  direction: droneData.direction || droneData.heading
                };
                MapService.updateDroneMarker(normalizedData);
              }
            } catch (e) {
              Utils.showMessage(`解析消息失败: ${e.message}`, true);
            }
          });
          
          // 连接错误回调
          appState.mqtt.client.on('error', (err) => {
            Utils.showMessage(`MQTT错误: ${err.message}`, true);
            this.disconnect();
          });
          
          // 断开连接回调
          appState.mqtt.client.on('close', () => {
            if (appState.mqtt.connected) {
              appState.mqtt.connected = false;
              Utils.showMessage('MQTT连接已断开');
            }
            this.updateConnectionUI(false);
          });
          
          // 重连回调
          appState.mqtt.client.on('reconnect', () => {
            Utils.showMessage('正在重连...');
            this.updateConnectionUI(false);
            DOM.mqttConnectBtn.textContent = '重连中...';
          });
        },
        
        // 断开MQTT连接
        disconnect() {
          if (appState.mqtt.client && appState.mqtt.connected) {
            appState.mqtt.client.end();
            appState.mqtt.connected = false;
            Utils.showMessage('已断开MQTT连接');
          }
          this.updateConnectionUI(false);
        },
        
        // 更新连接状态UI
        updateConnectionUI(connected) {
          if (connected) {
            DOM.mqttIndicator.className = 'status-indicator status-green';
            DOM.mqttStatus.textContent = 'MQTT已连接';
            DOM.mqttConnectBtn.disabled = true;
            DOM.mqttDisconnectBtn.disabled = false;
          } else {
            DOM.mqttIndicator.className = 'status-indicator status-red';
            DOM.mqttStatus.textContent = 'MQTT未连接';
            DOM.mqttConnectBtn.disabled = false;
            DOM.mqttDisconnectBtn.disabled = true;
            DOM.mqttConnectBtn.textContent = '连接';
            DOM.sendButton.disabled = true;
          }
        },
        
        // 发送消息
        sendMessage() {
          if (!appState.mqtt.connected || !appState.mqtt.publishTopic) return;
          
          const message = DOM.sendMessageInput.value.trim();
          if (!message) {
            Utils.showMessage('请输入要发送的消息', true);
            return;
          }
          
          try {
            // 验证JSON格式
            JSON.parse(message);
            
            appState.mqtt.client.publish(appState.mqtt.publishTopic, message, (err) => {
              if (err) {
                Utils.showMessage(`发送消息失败: ${err.message}`, true);
              } else {
                Utils.showMessage(`已发送消息到 ${appState.mqtt.publishTopic}: ${message}`);
                DOM.sendMessageInput.value = '';
              }
            });
          } catch (e) {
            Utils.showMessage(`消息格式错误: 请输入有效的JSON`, true);
          }
        }
      };

      // 事件监听
      function setupEventListeners() {
        // MQTT连接/断开
        DOM.mqttConnectBtn.addEventListener('click', () => MqttService.connect());
        DOM.mqttDisconnectBtn.addEventListener('click', () => MqttService.disconnect());
        
        // MQTT设置面板切换
        DOM.mqttSettingsToggle.addEventListener('click', () => {
          const content = DOM.mqttSettingsContent;
          const icon = DOM.mqttSettingsToggle.querySelector('.fa-chevron-down');
          
          if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
            content.style.maxHeight = '500px';
            content.style.opacity = '1';
            icon.style.transform = 'rotate(180deg)';
          } else {
            content.style.maxHeight = '0';
            content.style.opacity = '0';
            icon.style.transform = 'rotate(0)';
          }
        });
        
        // 发送消息按钮
        DOM.sendButton.addEventListener('click', () => MqttService.sendMessage());
        
        // 数据导出和清空
        DOM.exportDataBtn.addEventListener('click', () => DataManager.exportHistoricalData());
        DOM.clearDataBtn.addEventListener('click', () => DataManager.clearHistoricalData());
        
        // 设备ID变化时更新发布主题
        DOM.mqttDeviceIdInput.addEventListener('change', () => {
          const deviceId = DOM.mqttDeviceIdInput.value.trim();
          appState.mqtt.publishTopic = deviceId ? `terminal/l20/${deviceId}/setInfo` : '';
          DOM.sendButton.disabled = !appState.mqtt.connected || !appState.mqtt.publishTopic;
        });
      }

      // 初始化应用
      function initApp() {
        // 初始化地图
        MapService.initMap();
        
        // 设置事件监听
        setupEventListeners();
        
        // 初始化UI状态
        MqttService.updateConnectionUI(false);
        DOM.recordCountEl.textContent = appState.historicalData.length;
      }

      // 启动应用
      initApp();
	  
	  setTimeout(() => {
  if (!appState.mqtt.connected) {
    // 可以在这里提示用户连接，或者自动尝试连接
     MqttService.connect();
  }
}, 1000); // 页面加载1秒后再尝试连接
    });
  </script>
</body>
</html>