<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— äººæœºæ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        /* æ·»åŠ å¯åŠ¨å›¾ç‰‡è¦†ç›–å±‚æ ·å¼ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            cursor: pointer;
            transition: opacity 0.5s ease;
        }
        
        .splash-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* è®¾ç½®å¯¹è¯æ¡†æ ·å¼ */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .settings-content h3 {
            margin-top: 0;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        
        .settings-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .settings-btn {
            padding: 8px 16px;
            cursor: pointer;
        }
        
        .save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
            border: none;
        }
        
        .settings-button {
            margin-right: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body class="show-video-large">
    <!-- å¯åŠ¨å›¾ç‰‡è¦†ç›–å±‚ -->
    <div class="splash-screen" id="splash-screen">
        <img src="drone-splash.png" alt="æ— äººæœºæ§åˆ¶ç³»ç»Ÿå¯åŠ¨" class="splash-image">
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="connection-info">
            <!-- æ·»åŠ è®¾ç½®æŒ‰é’® -->
            <button class="settings-button" id="settings-button">ğŸ’»ï¸ï¸è®¾ç½®</button>
            <input id="roomIdInput" type="text" value="" placeholder="è¾“å…¥è®¾å¤‡ID">
            <button id="stat-button" >ğŸ”„è¿æ¥</button>
        </div> 
        <div class="drone-status">		
			<div id="mobmcc-data"></div>
            <div id="mobnet-data"></div>
			<div id="mobbnd-data"></div>
            <div id="mobpci-data"></div>
			<div id="mobrsp-data"></div>
			<div id="mobsnr-data"></div>
        </div>
        <!-- æ§åˆ¶æŒ‰é’®ç»„ - ç§»è‡³é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="control-buttons-group">
		   
            <button class="control-btn status-btn" onclick="droneARM()"> ğŸ”’è§£/ä¸Šé”</button>
            <button class="control-btn status-btn" onclick="dronetakeoff()">ğŸ›«èµ·/é™è½</button>
			<button class="control-btn status-btn" onclick="droneZTHX()">â¸ï¸æš‚/ç»§èˆª</button>
			<button class="control-btn status-btn" onclick="droneRTL()">ğŸ è¿”/å–èˆª</button>
			<button class="control-btn status-btn" onclick="openDroneSettings()">ğŸ“…æœº/è®¾ç½®</button>
        </div>

    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <!-- å¤§çª—å£åŒºåŸŸ -->
        <div class="large-view">
            <!-- å¤§è§†é¢‘çª—å£ -->
            <div class="video-large video-container" id="large-video-container">
                <video autoplay playsinline id="remote-video"></video>
                <div class="hud-elements">
   
                    <!-- è§†é¢‘åŠ è½½çŠ¶æ€ -->
                    <div id="video-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.5); padding: 10px;">
                        è§†é¢‘åŠ è½½ä¸­...
                    </div>
                    <div id="video-error" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(255,0,0,0.5); padding: 10px;">
                        è§†é¢‘åŠ è½½å¤±è´¥
                    </div>
					<!-- åœ¨è§†é¢‘å®¹å™¨å†…æ·»åŠ åˆ‡æ¢æŒ‰é’®ç»„ -->
					<div class="video-switch-buttons">
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(1, event)">ğŸ“¹å¹¿è§’</button>
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(2, event)">ğŸ“¹å˜ç„¦</button>
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(3, event)">ğŸ”å˜ç„¦+</button>
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(4, event)">ğŸ”å˜ç„¦-</button>
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(5, event)">ğŸ“¹ï¸çƒ­æˆåƒ</button>
					<button type="button" class="video-switch-btn" onclick="switchVideoSource(6, event)">ğŸ“¹FPV</button>
					</div>
					<div id="speed-data"></div>
					<div id="alt-data"></div>
					<div id="lon-data"></div>
					<div id="lat-data"></div>	
					<div id="gps-data"></div>
					<div id="mobtim-data"></div>
					<div id="batt-data"></div>	
					<!-- è§†é¢‘çŠ¶æ€æ˜¾ç¤º -->
					<div id="video-status" >è§†é¢‘ï¼šåœæ­¢</div>
					<div class="circle1" id="circle1">
					<div class="circle"></div>
					<div class="dashed-line" id="line"></div>
					</div>
					
					<div class="camera-controls">
						<button type="button" class="video-switch-btn camera-btn" onclick="dronepicter()">æ‹/ğŸ“¸</button>
						<button type="button" class="video-switch-btn camera-btn" onclick="dronevideo()">å½•/ğŸ›‘</button>
						<button type="button" class="video-switch-btn camera-btn" onclick="minolianjie()">å†Œ/ğŸ“</button>
					</div>
                </div>
            </div>
            
            <!-- å¤§åœ°å›¾çª—å£ -->
            <div class="map-large" id="map-container"></div>
            
            <!-- åœ°å›¾æœç´¢æ¡† -->
            <div class="search-container">
                <input id="search-input" type="text" placeholder="è¾“å…¥ç»çº¬åº¦:116.397,39.908">
                <button id="search-button" onclick="searchLocation()">ğŸ”æœç´¢</button>
            </div>
        </div>
        
        <!-- å°çª—å£åŒºåŸŸ - å·²è°ƒæ•´åˆ°å³ä¸Šè§’ -->
        <div class="small-view" onclick="toggleViews()">
            <!-- å°åœ°å›¾çª—å£ -->
            <div class="small-map" id="small-map-container"></div>
            
            <!-- å°è§†é¢‘çª—å£ -->
            <div class="small-video video-container">
                <video autoplay playsinline id="small-remote-video"></video>
            </div>
        </div>
        
        <!-- æ§åˆ¶åŒºåŸŸ -->
        <div class="controls-container">
            <!-- è§†é¢‘æ¨¡å¼æ§åˆ¶ -->
            <div class="video-controls">
                <div class="joystick-area">
                    <div class="joystick-container" id="left-joystick-container">
                        <div class="joystick-center"></div>
                        <div class="joystick" id="left-joystick"></div>
                        <div class="joystick-label">Cé«˜åº¦Z/Qèˆªå‘E</div>
                        <div class="joystick-values">
                            <span>X: <span id="left-joystick-x">0</span></span>
                            <span>Y: <span id="left-joystick-y">0</span></span>
                        </div>
                    </div>
                    
                    <div class="joystick-container" id="right-joystick-container">
                        <div class="joystick-center"></div>
                        <div class="joystick" id="right-joystick"></div>
                        <div class="joystick-label">Wä¿¯ä»°S/Aæ¨ªæ»šD</div>
                        <div class="joystick-values">
                            <span>X: <span id="right-joystick-x">0</span></span>
                            <span>Y: <span id="right-joystick-y">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div id="status">ğŸ®ä½¿ç”¨è™šæ‹Ÿæ‘‡æ†</div>
            </div>
            
            <!-- åœ°å›¾æ¨¡å¼æ§åˆ¶ -->
            <div class="map-controls">
			    <button class="control-btn" onclick="daorukml()">ğŸ“å¯¼å…¥èˆªçº¿</button>
				<!-- éšè—çš„æ–‡ä»¶é€‰æ‹©æ§ä»¶ï¼ˆç”¨äºè§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼‰ -->
				<input type="file" id="fileSelector" style="display: none;" accept=".txt" />
                <button class="control-btn" id="drawing-toggle" onclick="toggleDrawing()">ğŸ“Œå¼€å§‹ç»˜åˆ¶</button>
                <button class="control-btn" onclick="removeLastPoint()">âŒåˆ é™¤èˆªç‚¹</button>
                <button class="control-btn" onclick="clearAll()">âŒæ¸…ç©ºå…¨éƒ¨</button>
                <button class="control-btn" onclick="toggleExecutionPanel()">â–¶ï¸ä¸‹å‘èˆªçº¿</button>
				<button class="control-btn" onclick="daochukml()">ğŸ“„å¯¼å‡ºèˆªçº¿</button>
            </div>
        </div>
    </div>
    
    <!-- èˆªçº¿æ‰§è¡Œé¢æ¿ -->
    <div id="execution-panel">
        <button class="close-panel" onclick="toggleExecutionPanel()">Ã—</button>
        <h3>èˆªçº¿æ‰§è¡Œå‚æ•°</h3>
        
        <div class="form-group">
            <label for="flight-height">èˆªçº¿é«˜åº¦ (ç±³)</label>
            <input type="number" id="flight-height" value="90" min="10" step="5">
        </div>
        
        <div class="form-group">
            <label for="flight-speed">èˆªçº¿é€Ÿåº¦ (ç±³/ç§’)</label>
            <input type="number" id="flight-speed" value="5" min="1" step="1">
        </div>
        
        <div class="form-group">
            <label for="return-height">è¿”èˆªé«˜åº¦ (ç±³)</label>
            <input type="number" id="return-height" value="150" min="10" step="10">
        </div>
        
        <div class="form-group">
            <label for="lost-action">å¤±è”åŠ¨ä½œ</label>
            <select id="lost-action">
                <option value="return">è‡ªåŠ¨è¿”èˆª</option>
                <option value="hover">åŸåœ°æ‚¬åœ</option>
                <option value="land">åŸåœ°é™è½</option>
                <option value="continue">ç»§ç»­æ‰§è¡Œ</option>
            </select>
        </div>
        
        <button class="execute-btn" onclick="executeFlight()">ğŸ›«ç«‹å³æ‰§è¡Œ</button>
    </div>
    
    <!-- è®¾ç½®å¯¹è¯æ¡† -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <h3>ç³»ç»Ÿè®¾ç½®</h3>
            <div class="form-group">
                <label for="video-server">è§†é¢‘æœåŠ¡å™¨åœ°å€</label>
                <input type="text" id="video-server" placeholder="ä¾‹å¦‚: 42.236.120.68">
            </div>
            <div class="form-group">
                <label for="mqtt-server">MQTTæœåŠ¡å™¨åœ°å€</label>
                <input type="text" id="mqtt-server" placeholder="ä¾‹å¦‚: 1.94.67.34:8083">
            </div>
            <div class="settings-buttons">
                <button class="settings-btn cancel-btn" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="settings-btn save-btn" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

	
	<div class="drone-settings-modal" id="drone-settings-modal">
    <div class="drone-settings-content">
        <h3>æ— äººæœºè®¾ç½®</h3>
        
        <!-- é¿éšœè®¾ç½® -->
        <div class="toggle-group">
            <span class="toggle-label">é¿éšœåŠŸèƒ½</span>
            <label class="toggle-switch">
                <input type="checkbox" id="obstacle-avoidance">
                <span class="toggle-slider"onclick="enablebzkg()"></span>
            </label>
        </div> 	
        <!-- RTKè®¾ç½® -->
        <div class="toggle-group">
            <span class="toggle-label">RTKå®šä½</span>
            <label class="toggle-switch">
                <input type="checkbox" id="rtk-enabled">
                <span class="toggle-slider"onclick="enablertkkg()"></span>
            </label>
        </div>
		<!-- é‡ç½®ç›¸æœºè®¾ç½® -->
        <div class="form-group">
            <button class="settings-btn danger-btn" onclick="chongzhixiangji()">é‡ç½®ç›¸æœºè®¾ç½®ğŸ› ï¸</button>
        </div>
		<!-- æ›´æ–°è¿”èˆªç‚¹ -->
        <div class="form-group">
            <button class="settings-btn danger-btn" onclick="gengxinfanhangd()">æ›´æ–°è¿”èˆªç‚¹(âœˆï¸ä½ç½®)</button>
        </div>
        <!-- æ ¼å¼åŒ–SDå¡ -->
        <div class="form-group">
            <button class="settings-btn danger-btn" onclick="formatSdCard()">æ ¼å¼åŒ–SDå¡(âœˆï¸å­˜å‚¨)</button>
        </div>
		
		<!-- è¿”èˆªé«˜åº¦è®¾ç½® -->
        <div class="form-group">
            <label for="return-altitude">è¿”èˆªé«˜åº¦ (ç±³)</label>
            <input type="number" id="return-altitude" value="300" min="10" max="1500" step="1">
        </div>
        
        <div class="settings-buttons">
            <button class="settings-btn cancel-btn" onclick="closeDroneSettings()">å–æ¶ˆ</button>
            <button class="settings-btn save-btn" onclick="saveDroneSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>


    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "bb3b3425840367f4ef6fc0f03d51a637",
        };
    </script>
    <!--<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=c2c5ca77bbbc732a1144127e4ae9994b&plugin=AMap.Scale,AMap.UI,AMap.Terrain"></script> -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=c2c5ca77bbbc732a1144127e4ae9994b&plugin=AMap.ToolBar,AMap.HawkEye"></script>
    <script src="mqtt.min.js"></script>
   <!--<script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script> -->
   <!-- å¼•å…¥é«˜å¾·åœ°å›¾uiåº“ -->
   <script src="https://webapi.amap.com/loader.js"></script>
   <!--  <script src="https://webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script> -->
	<script src="mapin.js"></script>
    <!-- å¼•å…¥è§†é¢‘æ’­æ”¾ç›¸å…³SDK -->
    <script type="text/javascript" src="adapter-7.4.0.min.js"></script>
    <script type="text/javascript" src="srs.sdk.js"></script>
	<!-- ç§»é™¤åŸæœ‰çš„é™æ€å¼•å…¥ -->
	<!-- <script src="./mavlink2send.js"></script>
	<script src="./mavlink_functions.js"></script>
	<script src="./jpkz.js"></script>
	<script src="./gamepad.js"></script>
	<script src="coordtransform.js"></script> -->
	<!-- èˆªçº¿ç»˜åˆ¶é€»è¾‘ -->
	<script src="./hzhxzx.js"></script>
	<!--<script src="./xnyg.js"></script> -->
    <script>
	// æ·»åŠ å¯åŠ¨å›¾ç‰‡å…³é—­åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const splashScreen = document.getElementById('splash-screen');
        
        // ç‚¹å‡»å›¾ç‰‡å…³é—­å¯åŠ¨ç•Œé¢
        splashScreen.addEventListener('click', function() {
            // æ·»åŠ æ·¡å‡ºæ•ˆæœ
            splashScreen.style.opacity = '0';
            // åŠ¨ç”»ç»“æŸåéšè—å…ƒç´ 
            setTimeout(() => {
                splashScreen.style.display = 'none';
                // å¯åŠ¨ç¨‹åºæ­£å¸¸è¿è¡Œé€»è¾‘
                initApplication();
            }, 500);
        });
    });

    // åº”ç”¨åˆå§‹åŒ–å‡½æ•°
    function initApplication() {
        console.log('å¼€å§‹æ­£å¸¸è¿è¡Œ');
        // è¿™é‡Œå¯ä»¥æ·»åŠ ç¨‹åºå¯åŠ¨éœ€è¦æ‰§è¡Œçš„åˆå§‹åŒ–ä»£ç 
    }

	// é…ç½®å‚æ•° - é»˜è®¤ä¸ºåŸå§‹å€¼
    let config = {
        videoServer: '42.236.120.68',
        mqttServer: '1.94.67.34:8083'
    };
	
	let hudpitch = 0; // ä¿¯ä»°
    let hudroll = 0; //æ¨ªæ»š
	let roomId = 864284040603666;
	let MQTTXterminals = '/terminal/d10/'+ roomId+ '/setInfo';
	let MQTTXterminalg = '/terminal/d10/'+ roomId+ '/getInfo';

	// åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ èˆªè¿¹ç›¸å…³å˜é‡
	let flightPath = []; // å­˜å‚¨èˆªè¿¹ç‚¹
	const MAX_PATH_POINTS = 500; // æœ€å¤§èˆªè¿¹ç‚¹æ•°é‡ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
	let pathLineLarge = null; // å¤§åœ°å›¾èˆªè¿¹çº¿
	let pathLineSmall = null; // å°åœ°å›¾èˆªè¿¹çº¿

    // è§†é¢‘ç›¸å…³çŠ¶æ€
    let videoSdk = null;
    let isVideoPlaying = false;
	
	 // æ·»åŠ æ ‡è®°å˜é‡ç”¨äºæ§åˆ¶è„šæœ¬åŠ è½½çŠ¶æ€
	 let areMavlinkScriptsLoaded = false;
    // åŠ¨æ€åŠ è½½è„šæœ¬çš„å‡½æ•°
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    }

   document.querySelector("#roomIdInput").value = roomId;
	let rc0 = 0, rc1 = 0, rc2 = 0, rc3 = 0, rc4 = 0, rc5 = 0, rc6 = 0;//å®šä¹‰å››ä¸ªæ‘‡æ† 
	
		//å¼€å§‹è¿æ¥mqttæ¥æ”¶æ•°æ®	
	    console.log(mqtt); // å°†åœ¨å…¨å±€åˆå§‹åŒ–ä¸€ä¸ª mqtt å˜é‡
        const logElement = document.getElementById('log');
        const connectButton    = document.getElementById('stat-button');

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logEntry = `[${now}] ${message}\n`;
            logElement.value = logEntry + (logElement.value || '');
        }
		const logContainer = document.getElementById('logContainer');
        function connect() {
			// æ›´æ–°roomId
            updateRoomId();
            
			if(mqtt && mqtt.connected){
				alert("MQå·²ç»è¿æ¥");
				return;
			}
            // æ„å»ºWebSocket URL: ws://<host>:<port>/mqtt
             const url = `ws://${config.mqttServer}/mqtt`;
			 
			// åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
			const options = {
			  // Clean session
			  clean: false,
			  connectTimeout: 4000,
			  // è®¤è¯ä¿¡æ¯
			  clientId: 'emqx_test2',
			  username: '43',
			  password: '123456',
			  keepalive:600,
			  reconnnectPeriod: 10*1000
			}
            const client = mqtt.connect(url, options);
			mqtt = client;
            client.on('connect', async function() {
				client.subscribe(MQTTXterminalg);
				console.log(MQTTXterminalg);
				console.log('Connected');
				alert("MQå·²ç»è¿æ¥");
				 // è¿æ¥æˆåŠŸååŠ è½½æ‰€éœ€è„šæœ¬ï¼ˆä»…åŠ è½½ä¸€æ¬¡ï¼‰
            if (!areMavlinkScriptsLoaded) {
                try {
                    await Promise.all([
					    loadScript('./gamepadds.js'),
                        loadScript('./mavlink2send.js'),
                        loadScript('./mavlink_functions.js'),
                        loadScript('./jpkz.js'),
						loadScript('./xnyg.js'),
                        loadScript('coordtransform.js')
                    ]);
                    areMavlinkScriptsLoaded = true;
                   // console.log('ç›¸å…³è„šæœ¬åŠ è½½å®Œæˆ');
                } catch (error) {
                    console.error('è„šæœ¬åŠ è½½å¤±è´¥:', error);
                }	
				}
			// è¿æ¥æˆåŠŸåå¯åŠ¨è§†é¢‘æ’­æ”¾
                startVideoPlay();
			    initVideoControl();//åˆå§‹åŒ–è§†é¢‘åŒºåŸŸç‚¹å‡»
				initVideoControls();
				if (typeof initJoysticks === 'function') {
                initJoysticks();
            }
			})	

			// æ¥æ”¶æ¶ˆæ¯
			client.on('message', function (topic, message) {
				try {
					// å°†Bufferç±»å‹çš„messageè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå†è§£æä¸ºJSONå¯¹è±¡
					const str = message.toString(); 
					const jsonData = JSON.parse(str);  // è§£æJSONå¯¹è±¡
					
					//console.log('æ”¶åˆ° MQTTXterminalg ä¸»é¢˜æ¶ˆæ¯:', jsonData);
					if (topic != MQTTXterminalg) {
						mqtt.unsubscribe(topic);
					}
					// ä½¿ç”¨ç‹¬ç«‹JSæ–‡ä»¶ä¸­çš„å‡½æ•°å¤„ç†æ•°æ®
					const extractedData = processMqttData(jsonData);
					
					// æ›´æ–°é¡µé¢æ˜¾ç¤º
					if (extractedData) {
						updateDataDisplay(extractedData);
						
						// å¦‚æœéœ€è¦æ›´æ–°åœ°å›¾æ ‡è®°ä½ç½®ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
						if (extractedData.gps_longitude && extractedData.gps_latitude) {
							window.initialLon = extractedData.gps_longitude.toFixed(6);
							window.initialLat = extractedData.gps_latitude.toFixed(6);
							// console.log("lonï¼š", window.currentLon);
							// åŠ¨æ€ä¿®æ”¹å¤§åœ°å›¾æ ‡è®°æ—‹è½¬è§’åº¦ä¸º90åº¦
						//	window.largeMarker.setRotation(35);
							updateMarkerPosition();	  	
						}
					}
				} catch (error) {
					//console.error('æ¶ˆæ¯è§£æå¤±è´¥:', error, 'åŸå§‹æ¶ˆæ¯:', message.toString());
				}
			})

            client.on('error', function(err) {
            console.error('MQTTè¿æ¥é”™è¯¯:', err);
            });
        }
		function mqDisconnect() {
		   console.log('dsConnected');
		   alert("mqæ–­å¼€è¿æ¥");
           stopVideoPlay();
		   if(mqtt) {
               mqtt.connected = false;
               mqtt.end(true);
           }
        }
		
		
          // æ›´æ–°RoomIdå¹¶é‡æ–°åˆå§‹åŒ–ç›¸å…³é…ç½®
        function updateRoomId() {
            const newRoomId = document.querySelector("#roomIdInput").value.trim();
            if (newRoomId && newRoomId !== roomId) {
                roomId = newRoomId;
                // æ›´æ–°MQTTä¸»é¢˜
                MQTTXterminals = '/terminal/d10/'+ roomId+ '/setInfo';
                MQTTXterminalg = '/terminal/d10/'+ roomId+ '/getInfo';

                // å¦‚æœè§†é¢‘æ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°åŠ è½½
                if (isVideoPlaying) {
                    restartVideoPlay();
                }
                // å¦‚æœMQTTå·²è¿æ¥ï¼Œé‡æ–°è®¢é˜…
                if (mqtt && mqtt.connected) {
                    mqtt.unsubscribe(MQTTXterminalg);
                    mqtt.subscribe(MQTTXterminalg);
                }
            }
        }

		function uint8ArrayToHexString(uint8Array) {
            return Array.from(uint8Array).map(byte => byte.toString(16).padStart(2, '0')).join('');
        }
		
		
       connectButton.addEventListener('click', connect);
       // ç›‘å¬roomIdè¾“å…¥æ¡†å˜åŒ–
       document.querySelector("#roomIdInput").addEventListener('change', updateRoomId);
       
       // è®¾ç½®æŒ‰é’®äº‹ä»¶
       document.getElementById('settings-button').addEventListener('click', openSettings);


    // è§†é¢‘æ’­æ”¾ç›¸å…³å‡½æ•°
    async function startVideoPlay() {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('video-loading').style.display = 'block';
            document.getElementById('video-error').style.display = 'none';
            document.getElementById('video-status').textContent = 'è§†é¢‘ï¼šåŠ è½½ä¸­...';
            
            // å…³é—­å·²æœ‰è¿æ¥
            if (videoSdk) {
                await videoSdk.close();
            }

            videoSdk = new SrsRtcWhipWhepAsync();
            
            // å°†SDKçš„æµç»‘å®šåˆ°ä¸¤ä¸ªè§†é¢‘å…ƒç´ 
            document.getElementById('remote-video').srcObject = videoSdk.stream;
            document.getElementById('small-remote-video').srcObject = videoSdk.stream;

            // ä½¿ç”¨roomIdå’Œé…ç½®çš„è§†é¢‘æœåŠ¡å™¨åœ°å€åŠ¨æ€ç”Ÿæˆè§†é¢‘åœ°å€
            const whepUrl = `http://${config.videoServer}:1985/rtc/v1/whep/?app=live&stream=${roomId}.flv`;
            console.log('è§†é¢‘åœ°å€:', whepUrl);

            await videoSdk.play(whepUrl, {
                videoOnly: true,  // åªæ’­æ”¾è§†é¢‘
                audioOnly: false
            });
            
            // éšè—åŠ è½½çŠ¶æ€ï¼Œæ›´æ–°çŠ¶æ€ä¿¡æ¯
            document.getElementById('video-loading').style.display = 'none';
            document.getElementById('video-status').textContent = 'è§†é¢‘ï¼šæ’­æ”¾ä¸­';
            isVideoPlaying = true;

        } catch (error) {
            console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', error);
            document.getElementById('video-loading').style.display = 'none';
            document.getElementById('video-error').style.display = 'block';
            document.getElementById('video-status').textContent = 'è§†é¢‘ï¼šåŠ è½½å¤±è´¥';
            
            // æ¸…ç†è¿æ¥
            if (videoSdk) {
                try {
                    await videoSdk.close();
                } catch (closeErr) {
                    console.error('å…³é—­è§†é¢‘è¿æ¥é”™è¯¯:', closeErr);
                }
                videoSdk = null;
            }
            isVideoPlaying = false;
        }
    }

    // åœæ­¢è§†é¢‘æ’­æ”¾
    async function stopVideoPlay() {
        if (videoSdk) {
            try {
                await videoSdk.close();
                document.getElementById('video-status').textContent = 'è§†é¢‘ï¼šå·²åœæ­¢';
            } catch (error) {
                console.error('åœæ­¢è§†é¢‘é”™è¯¯:', error);
                document.getElementById('video-status').textContent = 'è§†é¢‘ï¼šåœæ­¢å¤±è´¥';
            }
            videoSdk = null;
            isVideoPlaying = false;
        }
    }

    // é‡æ–°åŠ è½½è§†é¢‘
    async function restartVideoPlay() {
        await stopVideoPlay();
        await startVideoPlay();
    }

    // è®¾ç½®å¯¹è¯æ¡†ç›¸å…³å‡½æ•°
    function openSettings() {
        // åŠ è½½å½“å‰é…ç½®åˆ°è¾“å…¥æ¡†
        document.getElementById('video-server').value = config.videoServer;
        document.getElementById('mqtt-server').value = config.mqttServer;
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        document.getElementById('settings-modal').style.display = 'flex';
    }
    
    function closeSettings() {
        // éšè—å¯¹è¯æ¡†
        document.getElementById('settings-modal').style.display = 'none';
    }
    
    function saveSettings() {
        // è·å–è¾“å…¥æ¡†çš„å€¼
        const videoServer = document.getElementById('video-server').value.trim();
        const mqttServer = document.getElementById('mqtt-server').value.trim();
        
        // éªŒè¯è¾“å…¥
        if (videoServer && mqttServer) {
            // ä¿å­˜é…ç½®
            config.videoServer = videoServer;
            config.mqttServer = mqttServer;
            
            // æç¤ºä¿å­˜æˆåŠŸ
            alert('è®¾ç½®å·²ä¿å­˜');
            
            // å¦‚æœå·²è¿æ¥ï¼Œéœ€è¦é‡æ–°è¿æ¥æ‰èƒ½ç”Ÿæ•ˆ
            if (mqtt && mqtt.connected) {
                mqDisconnect();
                setTimeout(connect, 1000);
            }
            
            // éšè—å¯¹è¯æ¡†
            closeSettings();
        } else {
            alert('è¯·å¡«å†™å®Œæ•´çš„æœåŠ¡å™¨åœ°å€');
        }
    }


	
//hudäº’åŠ¨å¼€å§‹

	function linehud(){
		const line = document.getElementById('line');
		const circle1 = document.getElementById('circle1');
	   let lineTop = hudpitch+50; // ä¿¯ä»°
	   let lineRotation = hudroll; //æ¨ªæ»š 
		line.style.top = `${lineTop}%`;
		line.style.transform = `rotate(${lineRotation}deg)`;
	   }
	   
   //hudäº’åŠ¨ç»“æŸ

//***************æ•°æ®å¤„ç†ç»“æŸ********************/   
        // å­˜å‚¨çª—å£çŠ¶æ€ä¿¡æ¯
        const windowState = {
            video: {
                zoom: 1,
                position: { x: 0, y: 0 }
            },
            map: {
                zoom: 14,
                center: [114.388185, 36.148881]
            }
        };
        
        // åˆ‡æ¢è§†å›¾æ¨¡å¼å¹¶åŒæ­¥ç¼©æ”¾çŠ¶æ€
		function toggleViews() {
			const body = document.body;
			const isVideoMode = body.classList.contains('show-video-large');
			
			// ä¿å­˜å½“å‰å¤§çª—å£çŠ¶æ€
			if (isVideoMode) {
				saveVideoState();
				applyMapState();
			} else {
				saveMapState();
				applyVideoState();
			}
			
			// åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ç±»
			body.classList.toggle('show-video-large');
			body.classList.toggle('show-map-large');
			
			// å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶åœ°å›¾é‡æ–°è®¡ç®—å°ºå¯¸
			setTimeout(() => {
				if (window.largeMap) window.largeMap.resize();
				if (window.smallMap) window.smallMap.resize();
			}, 50); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
			
			// åŒæ­¥å°çª—å£å†…å®¹
			syncSmallWindowContent();
		}
        // ä¿å­˜è§†é¢‘çª—å£çŠ¶æ€
        function saveVideoState() {
            windowState.video.zoom = 1;
        }
        
        // åº”ç”¨è§†é¢‘çª—å£çŠ¶æ€
        function applyVideoState() {
            const videoElement = document.getElementById('remote-video');
            if (videoElement) {
                videoElement.style.transform = `scale(${windowState.video.zoom})`;
            }
        }
        
        // ä¿å­˜åœ°å›¾çª—å£çŠ¶æ€
        function saveMapState() {
            if (window.largeMap) {
                windowState.map.zoom = window.largeMap.getZoom();
                windowState.map.center = window.largeMap.getCenter();
            }
        }
        
        // åº”ç”¨åœ°å›¾çª—å£çŠ¶æ€
        function applyMapState() {
            if (window.largeMap) {
                window.largeMap.setZoomAndCenter(
                    windowState.map.zoom,
                    windowState.map.center
                );
            }
        }
        
        // åŒæ­¥å°çª—å£å†…å®¹ä¸å¤§çª—å£
        function syncSmallWindowContent() {
            const isVideoMode = document.body.classList.contains('show-video-large');
            
            if (isVideoMode) {
                if (window.largeMap && window.smallMap) {
                    window.smallMap.setZoomAndCenter(
                        window.largeMap.getZoom(),
                        window.largeMap.getCenter()
                    );
                }
            }
        }
        
        // åˆå§‹åŒ–åœ°å›¾ - åˆ›å»ºä¸¤ä¸ªåœ°å›¾å®ä¾‹ï¼Œä¿æŒåŒæ­¥
        function initMaps() {
            // å¤§åœ°å›¾
            window.largeMap = new AMap.Map("map-container", {
                zoom: windowState.map.zoom,
                center: windowState.map.center,
                resizeEnable: true,
                rotateEnable: true,//æ˜¯å¦å¼€å¯åœ°å›¾æ—‹è½¬äº¤äº’ é¼ æ ‡å³é”® + é¼ æ ‡ç”»åœˆç§»åŠ¨ æˆ– é”®ç›˜Ctrl + é¼ æ ‡ç”»åœˆç§»åŠ¨
                pitchEnable: true,
                pitch: 0,
                rotation: 0,
                viewMode: '2D',//å¼€å¯3Dè§†å›¾,é»˜è®¤ä¸ºå…³é—­
                zooms: [2, 20],
                terrain: true// å¼€å¯åœ°å½¢å›¾
				
				
            });
            
            // å°åœ°å›¾
            window.smallMap = new AMap.Map("small-map-container", {
                zoom: windowState.map.zoom,
                center: windowState.map.center,
                resizeEnable: true,
                rotateEnable: false,
                pitchEnable: false,
                viewMode: '2D',
                zooms: [2, 20]
            });
            
            // ä¸ºä¸¤ä¸ªåœ°å›¾æ·»åŠ ç›¸åŒçš„æ§ä»¶å’Œè®¾ç½®
            setupMap(window.largeMap);
            setupMap(window.smallMap);
            
            // ç›‘å¬å¤§åœ°å›¾äº‹ä»¶ï¼ŒåŒæ­¥åˆ°å°åœ°å›¾
            window.largeMap.on('zoomend', function() {
                if (document.body.classList.contains('show-map-large')) {
                    window.smallMap.setZoom(window.largeMap.getZoom());
                }
            });
            
            window.largeMap.on('moveend', function() {
                if (document.body.classList.contains('show-map-large')) {
                    window.smallMap.setCenter(window.largeMap.getCenter());
                }
            });
            
            // åˆå§‹åŒ–é£æœºæ ‡è®°
            initDroneMarker();
        }
        
        // åœ°å›¾è®¾ç½® - å·²ç§»é™¤ç½—ç›˜å’Œç¼©æ”¾æ§ä»¶
        function setupMap(map) {
            // ä»…ä¿ç•™æ¯”ä¾‹å°ºæ§ä»¶
            AMap.plugin(["AMap.Scale"], function() {
                map.addControl(new AMap.Scale());
            });

            // ä¿ç•™å›¾å±‚åˆ‡æ¢æ§ä»¶
            AMapUI.loadUI(['control/BasicControl'], function(BasicControl) {
                var layerCtrl = new BasicControl.LayerSwitcher({
                    theme: 'common',
                    position: 'tr'
                });
                map.addControl(layerCtrl);
            });
            
            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            map.on('click', function(e) {
                const lngLatInput = document.getElementById("lngLatInfo");
                if (lngLatInput) {
                    lngLatInput.value = e.lnglat.getLng() + ',' + e.lnglat.getLat();
                }
                console.log(e.lnglat.getLng() + ',' + e.lnglat.getLat());
            });
        }
        
        // åˆå§‹åŒ–æ— äººæœºæ ‡è®° - ä½¿ç”¨åœ¨çº¿å›¾æ ‡ç¡®ä¿æ˜¾ç¤º
			function initDroneMarker() {
				const initialLon = window.initialLon || 114.388185;
				const initialLat = window.initialLat || 36.148881;
				
				const position = [initialLon, initialLat];
				// ä½¿ç”¨æ— äººæœºå›¾æ ‡æ˜¾ç¤º
				const icon = new AMap.Icon({
					size: new AMap.Size(32, 32),
					image: 'quadx.png', // æ›¿æ¢ä¸ºå®é™…æ— äººæœºå›¾æ ‡URL
					imageOffset: new AMap.Pixel(0, 0),
					anchor: new AMap.Pixel(16, 16), // æ—‹è½¬ä¸­å¿ƒç‚¹ï¼ˆå›¾æ ‡ä¸­å¿ƒï¼‰
					imageSize: new AMap.Size(32, 32),
				});
				
				// å¤§åœ°å›¾æ ‡è®°
				window.largeMarker = new AMap.Marker({
					position: position,
					map: window.largeMap,
					icon: icon,
					zIndex: 400,
					
				});
				
				// å°åœ°å›¾æ ‡è®°ï¼ˆåŒæ ·æ·»åŠ æ—‹è½¬å±æ€§ï¼‰
				window.smallMarker = new AMap.Marker({
					position: position,
					map: window.smallMap,
					icon: icon,
					zIndex: 400,
					
				});
//ç­‰å¾…åŠ å…¥markæ—‹è½¬é€»è¾‘
			}
        
// ä¿®æ”¹updateMarkerPositionå‡½æ•°ï¼Œæ·»åŠ èˆªè¿¹ç»˜åˆ¶é€»è¾‘
function updateMarkerPosition() {
    const currentLon = parseFloat(window.initialLon);
    const currentLat = parseFloat(window.initialLat);
    if (isNaN(currentLon) || isNaN(currentLat)) return;

    const newPosition = [currentLon, currentLat];
    window.largeMarker.setPosition(newPosition);
    window.smallMarker.setPosition(newPosition);

    // æ·»åŠ æ–°ä½ç½®åˆ°èˆªè¿¹æ•°ç»„
    flightPath.push(newPosition);
    
    // é™åˆ¶èˆªè¿¹ç‚¹æ•°é‡
    if (flightPath.length > MAX_PATH_POINTS) {
        flightPath.shift(); // ç§»é™¤æœ€æ—©çš„ç‚¹
    }

    // ç»˜åˆ¶èˆªè¿¹çº¿
    drawFlightPath();

    // ä¿æŒåŸæœ‰çš„åœ°å›¾å±…ä¸­é€»è¾‘
    if (document.body.classList.contains('show-video-large')) {
        window.smallMap.setCenter(newPosition);
    } else {
        window.largeMap.setCenter(newPosition);
    }
}

// æ·»åŠ ç»˜åˆ¶èˆªè¿¹çº¿çš„å‡½æ•°
function drawFlightPath() {
    // è‡³å°‘éœ€è¦ä¸¤ä¸ªç‚¹æ‰èƒ½ç»˜åˆ¶çº¿æ®µ
    if (flightPath.length < 2) return;

    // å®šä¹‰èˆªè¿¹çº¿æ ·å¼ï¼šç°è‰²è™šçº¿
    const pathStyle = {
        strokeColor: "#999", // ç°è‰²
        strokeWeight: 2,
        strokeStyle: "dashed", // è™šçº¿
        strokeDasharray: [10, 5], // è™šçº¿æ ·å¼
        zIndex: 350 // ç¡®ä¿åœ¨æ ‡è®°ä¸‹æ–¹
    };

    // æ›´æ–°æˆ–åˆ›å»ºå¤§åœ°å›¾èˆªè¿¹çº¿
    if (pathLineLarge) {
        pathLineLarge.setPath(flightPath);
    } else {
        pathLineLarge = new AMap.Polyline({
            path: flightPath,
            ...pathStyle,
            map: window.largeMap
        });
    }

    // æ›´æ–°æˆ–åˆ›å»ºå°åœ°å›¾èˆªè¿¹çº¿
    if (pathLineSmall) {
        pathLineSmall.setPath(flightPath);
    } else {
        pathLineSmall = new AMap.Polyline({
            path: flightPath,
            ...pathStyle,
            map: window.smallMap
        });
    }
}

// æ·»åŠ æ¸…é™¤èˆªè¿¹çš„å‡½æ•°ï¼ˆå¯é€‰ï¼Œç”¨äºéœ€è¦é‡ç½®èˆªè¿¹çš„åœºæ™¯ï¼‰
function clearFlightPath() {
    flightPath = [];
    if (pathLineLarge) {
        pathLineLarge.remove();
        pathLineLarge = null;
    }
    if (pathLineSmall) {
        pathLineSmall.remove();
        pathLineSmall = null;
    }
}
 
      
        // åœ°å›¾æœç´¢åŠŸèƒ½
        function searchLocation() {
            const input = document.getElementById('search-input').value.trim();
            if (!input) return;
            
            const [lng, lat] = input.split(',').map(Number);
            if (!isNaN(lng) && !isNaN(lat)) {
                window.largeMap.setCenter([lng, lat]);
                window.smallMap.setCenter([lng, lat]);
                windowState.map.center = [lng, lat];
            }
        }


        
        // åˆ‡æ¢èˆªçº¿æ‰§è¡Œé¢æ¿
        function toggleExecutionPanel() {
            const panel = document.getElementById('execution-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

	
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = () => {
            initMaps();
            syncSmallWindowContent();

        };
    </script>
</body>
</html>